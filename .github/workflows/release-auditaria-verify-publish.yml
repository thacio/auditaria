name: Release NPMJS Auditaria (Verify + Optional Publish)

on:
  workflow_dispatch:
    inputs:
      ref:
        description: "Branch, tag, or commit SHA to build"
        required: true
        default: "main"
        type: string
      release_version:
        description: "Manual version override (examples: 0.30.0 or v0.30.0). Leave empty for automatic versioning."
        required: false
        type: string
      version_bump:
        description: "Automatic version bump when release_version is empty"
        required: true
        default: "patch"
        type: choice
        options:
          - patch
          - minor
          - major
      npm_tag:
        description: "Tag to publish on npm"
        required: true
        default: "latest"
        type: choice
        options:
          - latest
          - preview
          - nightly
          - dev
      run_tests:
        description: "Run tests before build (npm run test:ci)"
        required: true
        default: false
        type: boolean
      enable_publish:
        description: "Run the publish job. If false, workflow only builds and verifies the package."
        required: true
        default: false
        type: boolean
      dry_run_publish:
        description: "Publish simulation mode. True = run npm publish --dry-run (no upload). False = real npm publish."
        required: true
        default: true
        type: boolean

jobs:
  build_bundle_pack:
    runs-on: ubuntu-latest
    outputs:
      package_version: ${{ steps.prepare_package.outputs.package_version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.ref }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Prepare publish package.json
        id: prepare_package
        env:
          RELEASE_VERSION: ${{ github.event.inputs.release_version }}
          VERSION_BUMP: ${{ github.event.inputs.version_bump }}
        run: |
          node <<'NODE'
          const fs = require('node:fs');

          const packageJsonPath = 'package.json';
          const packageJson = JSON.parse(fs.readFileSync(packageJsonPath, 'utf8'));
          const versionInput = (process.env.RELEASE_VERSION || '').trim();
          const versionBump = (process.env.VERSION_BUMP || 'patch').trim();
          const semverRegex =
            /^(0|[1-9]\d*)\.(0|[1-9]\d*)\.(0|[1-9]\d*)(?:-[0-9A-Za-z.-]+)?(?:\+[0-9A-Za-z.-]+)?$/;
          const coreSemverRegex = /^(\d+)\.(\d+)\.(\d+)/;

          function parseCoreSemver(value) {
            const normalized = String(value).trim().replace(/^v/, '');
            const match = normalized.match(coreSemverRegex);
            if (!match) {
              throw new Error(
                `Cannot auto-version from "${value}". Expected a version starting with X.Y.Z.`,
              );
            }
            return {
              major: Number(match[1]),
              minor: Number(match[2]),
              patch: Number(match[3]),
            };
          }

          let versionSource = 'manual';

          packageJson.private = false;
          if (packageJson.scripts?.prepare) {
            // prepare is not needed in CI here; we run build/bundle explicitly below.
            delete packageJson.scripts.prepare;
          }

          if (versionInput) {
            const normalizedVersion = versionInput.startsWith('v')
              ? versionInput.slice(1)
              : versionInput;

            if (!semverRegex.test(normalizedVersion)) {
              throw new Error(
                `Invalid release_version "${versionInput}". Use semver like "0.28.0" or "v0.28.0".`,
              );
            }

            packageJson.version = normalizedVersion;
          } else {
            const current = parseCoreSemver(packageJson.version);
            let next = { ...current };

            if (versionBump === 'major') {
              next = { major: current.major + 1, minor: 0, patch: 0 };
            } else if (versionBump === 'minor') {
              next = { major: current.major, minor: current.minor + 1, patch: 0 };
            } else {
              next = {
                major: current.major,
                minor: current.minor,
                patch: current.patch + 1,
              };
            }

            packageJson.version = `${next.major}.${next.minor}.${next.patch}`;
            versionSource = `auto-${versionBump}`;
          }

          fs.writeFileSync(
            packageJsonPath,
            `${JSON.stringify(packageJson, null, 2)}\n`,
          );
          fs.appendFileSync(
            process.env.GITHUB_OUTPUT,
            `package_version=${packageJson.version}\n`,
          );
          fs.appendFileSync(
            process.env.GITHUB_OUTPUT,
            `version_source=${versionSource}\n`,
          );

          console.log(
            `Prepared ${packageJson.name}@${packageJson.version} (source=${versionSource}, private=${packageJson.private})`,
          );
          NODE

      - name: Run tests
        if: ${{ github.event.inputs.run_tests == 'true' }}
        run: npm run test:ci

      - name: Build
        run: npm run build

      - name: Bundle
        run: npm run bundle

      - name: Pack publish artifact
        run: |
          rm -rf pack-artifacts
          mkdir -p pack-artifacts
          npm pack --ignore-scripts --pack-destination ./pack-artifacts
          PACK_FILE="$(ls -1 ./pack-artifacts/*.tgz | head -n1)"
          mv "$PACK_FILE" ./auditaria-package.tgz
          ls -lah auditaria-package.tgz

      - name: Verify packaged artifact
        run: |
          tar -tf auditaria-package.tgz > tar-contents.txt
          grep -q '^package/package.json$' tar-contents.txt
          grep -q '^package/bundle/gemini.js$' tar-contents.txt
          node <<'NODE'
          const { execSync } = require('node:child_process');

          const packedPackageJson = execSync(
            'tar -xOf auditaria-package.tgz package/package.json',
            { encoding: 'utf8' },
          );
          const packageJson = JSON.parse(packedPackageJson);

          if (packageJson.private !== false) {
            throw new Error('Publish artifact still has private=true.');
          }
          if (packageJson.name !== '@thacio/auditaria') {
            throw new Error(`Unexpected package name: ${packageJson.name}`);
          }
          if (!packageJson.bin || packageJson.bin.auditaria !== 'bundle/gemini.js') {
            throw new Error('bin.auditaria must point to bundle/gemini.js');
          }

          console.log(
            `Artifact validated for ${packageJson.name}@${packageJson.version}`,
          );
          NODE

      - name: Verify npm publish (dry-run)
        run: npm publish --dry-run --access public ./auditaria-package.tgz

      - name: Upload package artifact
        uses: actions/upload-artifact@v4
        with:
          name: npm-package-auditaria
          path: auditaria-package.tgz

  publish_npm:
    needs: [build_bundle_pack]
    if: ${{ github.event.inputs.enable_publish == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Download package artifact
        uses: actions/download-artifact@v4
        with:
          name: npm-package-auditaria

      - name: Setup Node.js for npm publish
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          registry-url: "https://registry.npmjs.org"

      - name: Publish package to npm
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
          NPM_TAG: ${{ github.event.inputs.npm_tag }}
          DRY_RUN: ${{ github.event.inputs.dry_run_publish }}
        run: |
          if [ "$DRY_RUN" = "true" ]; then
            npm publish --dry-run --access public --tag "$NPM_TAG" ./auditaria-package.tgz
          else
            npm publish --access public --tag "$NPM_TAG" ./auditaria-package.tgz
          fi

      - name: Verify published version
        if: ${{ github.event.inputs.dry_run_publish != 'true' }}
        run: |
          npm view @thacio/auditaria@${{ needs.build_bundle_pack.outputs.package_version }} version
